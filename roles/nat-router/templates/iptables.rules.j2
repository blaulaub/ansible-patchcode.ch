# iptable rules.
#
# Autogenerated by ansible. Any changes are likely to be overwritten
# the next time ansible runs.
#
# The content is compatible with iptables-save and iptables-restore.
#
# One way to active this automatically is to have in /etc/network/interfaces
# following line:
#
#   pre-up iptables-restore < /etc/iptables.rules

*nat
{% for item in network_routes[this_host_label].forwards %}
{% for port in item.ports %}
{% for proto in item.protos %}
-A PREROUTING  -i {{ wan_nic }} -p {{ proto }} -m {{ proto }} --dport {{ "%5d"|format(port) }} -j DNAT --to-destination {{ item.destination }}:{{ port }}
{% endfor %}
{% endfor %}
{% endfor %}
-A POSTROUTING -o {{ wan_nic }} -j MASQUERADE
COMMIT

*filter
-A INPUT -i lo   -j ACCEPT
-A INPUT -i {{ lan_nic }} -j ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -i {{ wan_nic }} -j DROP
{% for ip_address in ip_blacklist %}
-A FORWARD -i {{ wan_nic }} -s {{ ip_address }} -j DROP
{% endfor %}
{% for item in network_routes[this_host_label].forwards %}
{% for port in item.ports %}
{% for proto in item.protos %}
-A FORWARD -i {{ wan_nic }} -p {{ proto }} -m {{ proto }} --dport {{ "%5d"|format(port) }} -m state --state NEW -j ACCEPT
{% endfor %}
{% endfor %}
{% endfor %}
COMMIT
